@attribute [StreamRendering]

<figure @key="_imageId" class="@FigureClass" style="@ContainerStyle">
    @if (!_isLoadComplete)
    {
        <div class="image-loader-container" role="status" aria-live="polite">
            <img src="@Src"
                 alt="@Alt"
                 loading="@GetLoadAttributes.Loading"
                 decoding="@GetLoadAttributes.Decoding" />

            <div class="overlay">
                <div class="loader loader-spinner" aria-hidden="true">
                    <div class="spinner"></div>
                </div>
                <p> @_loadingPercentage%</p>
                <p class="optimization-text" aria-hidden="true">@_statusMessage</p>
            </div>

        </div>
    }
    else if (!string.IsNullOrEmpty(_error))
    {
        @if (!string.IsNullOrEmpty(DefaultSrc))
        {
            <picture>
                <source type="@MimeType" srcset="@DefaultSrc" />
                <img src="@DefaultSrc"
                     alt="@Alt"
                     class="@CssClass"
                     style="@Style"
                     width="@Width"
                     height="@Height" />
            </picture>
        }
        else
        {
            <div class="error-message" role="alert" aria-live="assertive">
                <p class="sr-only">Image failed to load</p>
                <p>Failed to load image: @_error</p>
            </div>
        }
    }
    else
    {
        <picture>
            <source type="@MimeType" srcset="@_srcset" data-srcset="@_dataSrcset" sizes="@_sizesAttr" />
            <source type="image/jpeg" srcset="@FallbackImageSrc" sizes="@_sizesAttr" />
            <img src="@FallbackImageSrc"
                 alt="@Alt"
                 loading="@GetLoadAttributes.Loading"
                 decoding="@GetLoadAttributes.Decoding"
                 class="@GetLoadAttributes.Class @CssClass"
                 style="@Style"
                 width="@Width"
                 height="@Height"
                 aria-describedby="@_imageId"
                 @attributes="AdditionalAttributes"
                 @ref="_imageRef" />
        </picture>
        @if (IsPreload)
        {
            <SectionContent SectionName="@_imageId">
                <link rel="preload"
                      as="image"
                      href="@FallbackImageSrc"
                      type="@MimeType"
                      imagesrcset="@_srcset"
                      imagesizes="@_sizesAttr"
                      fetchpriority="high" />
            </SectionContent>
        }
    }
    @if (HasCaption)
    {
        <figcaption id="@_imageId" class="@ComputedCaptionClass">@Caption</figcaption>
    }
</figure>

@if (EnableDeveloperMode)
{
    <DeveloperInfoPanel ImageComponent="this" />
}
